<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="description" content="Kies een cognitief domein - MOCIA Gezondheidsapp">
  <meta name="theme-color" content="#1976D2">
  <title>Kies Cognitief Domein - MOCIA</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/MOCIA/manifest.json">

  <!-- iOS Specific Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MOCIA">
  <link rel="apple-touch-icon" href="/MOCIA/icons/icon-192.png">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="shared/styles/design-system.css">
  <link rel="stylesheet" href="shared/styles/components.css">
  <link rel="stylesheet" href="shared/styles/animations.css">
  <link rel="stylesheet" href="shared/styles/mobile-first.css">
  <link rel="stylesheet" href="shared/styles/mobile-optimizations.css">
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Settings button (always visible) -->
  <button id="settings-button" class="settings-button" aria-label="Settings" style="position: fixed; top: var(--spacing-md); right: var(--spacing-md); width: var(--touch-target-min); height: var(--touch-target-min); border-radius: 50%; background-color: rgba(255, 255, 255, 0.9); color: var(--color-info); font-size: 24px; border: none; box-shadow: var(--shadow-md); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: var(--z-elevated);">
    ‚öôÔ∏è
  </button>

  <!-- Main content -->
  <main id="main-content">
    <!-- Domain Selection Screen -->
    <div class="screen">
      <div class="simple-screen__back" style="position: fixed; top: var(--spacing-md); left: var(--spacing-md); z-index: var(--z-elevated); display: flex; gap: var(--spacing-sm);">
        <button onclick="history.back()" class="btn btn-secondary simple-screen__back-button">‚Üê Terug</button>
        <button onclick="window.location.href='domains.html'" class="btn btn-secondary simple-screen__back-button" title="Terug naar hoofdmenu">üè†</button>
      </div>

      <div style="padding-top: 100px; padding-left: var(--spacing-md); padding-right: var(--spacing-md); padding-bottom: var(--spacing-xl);">
        <h1 style="text-align: center; font-size: var(--font-size-xxl); margin-bottom: var(--spacing-xl);">Kies een Cognitief Domein</h1>
        <div id="domains-grid" style="display: flex; flex-wrap: wrap; gap: var(--spacing-lg); max-width: 1200px; margin: 0 auto; justify-content: center;">
          <style>
            /* Desktop: 3 columns */
            @media (min-width: 1025px) {
              #domains-grid {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr);
              }
              #domains-grid > * {
                width: 100%;
              }
            }

            /* Tablet: 2 columns */
            @media (min-width: 769px) and (max-width: 1024px) {
              #domains-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr);
              }
              #domains-grid > * {
                width: 100%;
              }
            }

            /* Mobile: Single column (handled by mobile-optimizations.css) */
            @media (max-width: 768px) {
              #domains-grid {
                display: flex !important;
                flex-direction: column;
              }
              #domains-grid > * {
                width: 100%;
              }
            }
          </style>
        </div>
      </div>
    </div>
  </main>

  <!-- Load shared JavaScript modules -->
  <script src="shared/js/constants.js"></script>
  <script src="shared/js/audio-manager.js"></script>
  <script src="shared/js/data-tracker.js"></script>
  <script src="shared/js/ui-components.js"></script>
  <script src="shared/utils/statistics.js"></script>

  <!-- Domain selection JavaScript -->
  <script>
    class DomainSelector {
      constructor() {
        this.domains = [
          {
            id: CONSTANTS.COGNITIVE_DOMAINS.WORKING_MEMORY,
            title: 'Werkgeheugen',
            icon: 'üî¢',
            shortLabel: 'Onthouden & Gebruiken',
            color: '#1976D2',
          },
          {
            id: CONSTANTS.COGNITIVE_DOMAINS.PROCESSING_SPEED,
            title: 'Verwerkingssnelheid',
            icon: '‚ö°',
            shortLabel: 'Sneller Denken',
            color: '#F57C00',
          },
          {
            id: CONSTANTS.COGNITIVE_DOMAINS.ATTENTION,
            title: 'Aandacht',
            icon: 'üëÅÔ∏è',
            shortLabel: 'Scherp Blijven',
            color: '#388E3C',
          },
          {
            id: CONSTANTS.COGNITIVE_DOMAINS.EXECUTIVE_FUNCTION,
            title: 'Executieve Functies',
            icon: 'üß©',
            shortLabel: 'Plannen & Organiseren',
            color: '#7B1FA2',
          },
          {
            id: CONSTANTS.COGNITIVE_DOMAINS.EPISODIC_MEMORY,
            title: 'Episodisch Geheugen',
            icon: 'üìù',
            shortLabel: 'Momenten Herinneren',
            color: '#C62828',
          },
        ];

        this.init();
      }

      async init() {
        try {
          // Load settings
          this.loadSettings();

          // Set up event listeners
          this.setupEventListeners();

          // Render domain grid
          this.renderDomainGrid();

          // Speak welcome (optional, may fail on page load due to browser restrictions)
          if (window.AudioManager && window.AudioManager.isEnabled()) {
            try {
              await window.AudioManager.speak('Kies een cognitief domein');
            } catch (speechError) {
              // Speech may fail on page load - this is expected browser behavior
              console.log('Speech unavailable on page load:', speechError);
            }
          }
        } catch (error) {
          console.error('Initialization error:', error);
          alert('Er is een fout opgetreden bij het laden van de applicatie.');
        }
      }

      setupEventListeners() {
        // Settings button
        document.getElementById('settings-button').addEventListener('click', () => {
          this.showSettingsModal();
        });
      }

      renderDomainGrid() {
        const gridContainer = document.getElementById('domains-grid');
        UIComponents.clearElement(gridContainer);

        // Render each domain card in the grid
        this.domains.forEach(domain => {
          const card = this.renderDomainCard(domain);

          // Make card clickable
          card.style.cursor = 'pointer';
          card.addEventListener('click', () => {
            this.navigateToExercises(domain);
          });

          // Add hover effect
          card.addEventListener('mouseenter', () => {
            card.style.transform = 'translateY(-4px)';
            card.style.boxShadow = 'var(--shadow-lg)';
          });

          card.addEventListener('mouseleave', () => {
            card.style.transform = 'translateY(0)';
            card.style.boxShadow = 'var(--shadow-md)';
          });

          gridContainer.appendChild(card);
        });
      }

      renderDomainCard(domain) {
        const card = document.createElement('div');
        card.className = 'card-mobile';
        card.style.borderTop = `4px solid ${domain.color}`;
        card.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';

        card.innerHTML = `
          <div class="card-mobile__icon">${domain.icon}</div>
          <h3 class="card-mobile__title" style="color: ${domain.color};">${domain.shortLabel}</h3>
        `;

        return card;
      }

      navigateToExercises(domain) {
        // Haptic feedback
        if (window.AudioManager) {
          window.AudioManager.hapticPress();
        }

        // Speak domain name
        if (window.AudioManager && window.AudioManager.isEnabled()) {
          window.AudioManager.speak(`${domain.title} oefeningen`);
        }

        // Navigate to exercises page with domain parameter
        window.location.href = `exercises.html?domain=${domain.id}`;
      }

      showSettingsModal() {
        const audioEnabled = window.AudioManager.isEnabled();

        const content = document.createElement('div');
        content.innerHTML = `
          <div style="margin-bottom: var(--spacing-lg);">
            <label style="display: flex; align-items: center; font-size: var(--font-size-lg); cursor: pointer;">
              <input type="checkbox" id="audio-toggle" ${audioEnabled ? 'checked' : ''}
                     style="width: 30px; height: 30px; margin-right: var(--spacing-md); cursor: pointer;">
              <span>üîä Voice-over (gesproken instructies)</span>
            </label>
            <p style="margin: var(--spacing-sm) 0 0 calc(30px + var(--spacing-md)); font-size: var(--font-size-md); color: var(--color-text-secondary);">
              Laat de app instructies en feedback hardop voorlezen
            </p>
          </div>

          <div style="margin-bottom: var(--spacing-lg);">
            <label style="display: flex; align-items: center; font-size: var(--font-size-lg); cursor: pointer;">
              <input type="checkbox" id="large-text-toggle" ${document.body.classList.contains('large-text') ? 'checked' : ''}
                     style="width: 30px; height: 30px; margin-right: var(--spacing-md); cursor: pointer;">
              <span>Grote tekst modus</span>
            </label>
          </div>

          <div style="margin-bottom: var(--spacing-lg);">
            <label style="display: flex; align-items: center; font-size: var(--font-size-lg); cursor: pointer;">
              <input type="checkbox" id="high-contrast-toggle" ${document.body.classList.contains('high-contrast') ? 'checked' : ''}
                     style="width: 30px; height: 30px; margin-right: var(--spacing-md); cursor: pointer;">
              <span>Hoog contrast modus</span>
            </label>
          </div>

          <hr style="margin: var(--spacing-lg) 0; border: none; border-top: 1px solid var(--color-border-light);">

          <div style="text-align: center;">
            <p style="margin-bottom: var(--spacing-md);">Gegevensbeheer</p>
            <button id="export-data-btn" class="btn btn-secondary" style="margin-bottom: var(--spacing-sm); width: 100%;">
              Exporteer Gegevens
            </button>
            <button id="clear-data-btn" class="btn btn-error" style="width: 100%;">
              Wis Alle Gegevens
            </button>
          </div>
        `;

        const modal = UIComponents.createModal(
          'Instellingen',
          content,
          [
            {
              text: 'Sluiten',
              onClick: (e, modalEl) => modalEl.remove(),
              options: { variant: 'primary' },
            },
          ]
        );

        // Set up settings event listeners
        modal.querySelector('#audio-toggle').addEventListener('change', (e) => {
          if (e.target.checked) {
            window.AudioManager.enable();
            window.AudioManager.speak('Voice-over ingeschakeld. Instructies worden nu hardop voorgelezen.');
          } else {
            window.AudioManager.speak('Voice-over uitgeschakeld');
            setTimeout(() => {
              window.AudioManager.disable();
            }, 2000); // Wait for speech to finish
          }
        });

        modal.querySelector('#large-text-toggle').addEventListener('change', (e) => {
          document.body.classList.toggle('large-text', e.target.checked);
          this.saveSetting('largeText', e.target.checked);
        });

        modal.querySelector('#high-contrast-toggle').addEventListener('change', (e) => {
          document.body.classList.toggle('high-contrast', e.target.checked);
          this.saveSetting('highContrast', e.target.checked);
        });

        modal.querySelector('#export-data-btn').addEventListener('click', () => {
          this.exportData();
        });

        modal.querySelector('#clear-data-btn').addEventListener('click', () => {
          this.confirmClearData(modal);
        });

        UIComponents.showModal(modal);
      }

      saveSetting(key, value) {
        try {
          let settings = {};
          const existing = localStorage.getItem(CONSTANTS.STORAGE_KEYS.APP_SETTINGS);
          if (existing) {
            settings = JSON.parse(existing);
          }
          settings[key] = value;
          localStorage.setItem(CONSTANTS.STORAGE_KEYS.APP_SETTINGS, JSON.stringify(settings));
        } catch (error) {
          console.error('Error saving setting:', error);
        }
      }

      loadSettings() {
        try {
          const settings = localStorage.getItem(CONSTANTS.STORAGE_KEYS.APP_SETTINGS);
          if (settings) {
            const parsed = JSON.parse(settings);
            if (parsed.largeText) {
              document.body.classList.add('large-text');
            }
            if (parsed.highContrast) {
              document.body.classList.add('high-contrast');
            }
          }
        } catch (error) {
          console.error('Error loading settings:', error);
        }
      }

      exportData() {
        const data = window.DataTracker.exportData();
        if (!data) {
          alert('Geen gegevens om te exporteren.');
          return;
        }

        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mocia-cognitive-training-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        if (window.AudioManager) {
          window.AudioManager.speak('Gegevens ge√´xporteerd');
        }
      }

      confirmClearData(parentModal) {
        const confirmModal = UIComponents.createModal(
          'Wis Alle Gegevens',
          '<p style="font-size: var(--font-size-lg);">Weet u zeker dat u alle gegevens wilt wissen? Dit kan niet ongedaan worden gemaakt.</p>',
          [
            {
              text: 'Annuleren',
              onClick: (e, modalEl) => modalEl.remove(),
              options: { variant: 'secondary' },
            },
            {
              text: 'Ja, Wis Alles',
              onClick: (e, modalEl) => {
                window.DataTracker.clearAllData();
                modalEl.remove();
                parentModal.remove();

                if (window.AudioManager) {
                  window.AudioManager.speak('Alle gegevens gewist');
                }

                alert('Alle gegevens zijn gewist.');
                window.location.reload();
              },
              options: { variant: 'error' },
            },
          ]
        );

        UIComponents.showModal(confirmModal);
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        new DomainSelector();
      });
    } else {
      new DomainSelector();
    }
  </script>

  <!-- PWA Installer -->
  <script src="shared/js/pwa-installer.js"></script>
</body>
</html>
