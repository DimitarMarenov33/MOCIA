<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="description" content="Cognitieve trainingsoefeningen voor ouderen - MOCIA Gezondheidsapp">
  <meta name="theme-color" content="#1976D2">
  <title>MOCIA Cognitieve Training</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/MOCIA/manifest.json">

  <!-- iOS Specific Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MOCIA">
  <link rel="apple-touch-icon" href="/MOCIA/icons/icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/MOCIA/assets/icons/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/MOCIA/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/MOCIA/assets/icons/favicon-16x16.png">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="shared/styles/design-system.css">
  <link rel="stylesheet" href="shared/styles/components.css">
  <link rel="stylesheet" href="shared/styles/animations.css">
  <link rel="stylesheet" href="shared/styles/mobile-first.css">
  <link rel="stylesheet" href="shared/styles/mobile-optimizations.css">
  <link rel="stylesheet" href="shared/styles/personalization.css">
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Settings button (always visible) -->
  <button id="settings-button" class="settings-button" aria-label="Settings" style="position: fixed; top: var(--spacing-md); right: var(--spacing-md); width: var(--touch-target-min); height: var(--touch-target-min); border-radius: 50%; background-color: rgba(255, 255, 255, 0.9); color: var(--color-info); font-size: 24px; border: none; box-shadow: var(--shadow-md); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: var(--z-elevated);">
    ‚öôÔ∏è
  </button>

  <!-- Main content -->
  <main id="main-content">
    <!-- Welcome Splash -->
    <div id="welcome-screen" class="center-content">
      <div class="simple-screen__icon">üß†</div>
      <h1 class="simple-screen__title">Cognitieve Training</h1>
      <p class="simple-screen__description">Houd uw geest scherp met wetenschappelijk onderbouwde oefeningen</p>
      <div class="simple-screen__actions">
        <button id="start-button" class="btn btn-success btn-large">Start ‚Üí</button>
      </div>
    </div>

    <!-- Dashboard (for returning users) -->
    <div id="dashboard-screen" class="simple-screen" style="display: none;">
      <div class="simple-screen__back" style="display: flex; gap: var(--spacing-sm);">
        <button id="dashboard-back-button" class="btn btn-secondary simple-screen__back-button">‚Üê Terug</button>
        <button onclick="window.location.href='domains.html'" class="btn btn-secondary simple-screen__back-button" title="Terug naar hoofdmenu">üè†</button>
      </div>

      <div class="simple-screen__content">
        <h1 class="simple-screen__title">Uw Voortgang</h1>
        <div id="dashboard-stats" style="background: var(--color-background-alt); border-radius: var(--border-radius-lg); padding: var(--spacing-xl); margin: var(--spacing-lg) 0;"></div>
        <div class="simple-screen__actions">
          <button id="continue-button" class="btn btn-success btn-large">Ga Verder ‚Üí</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Load shared JavaScript modules -->
  <script src="shared/js/viewport-fix.js"></script>
  <script src="shared/js/constants.js"></script>
  <script src="shared/js/audio-manager.js"></script>
  <script src="shared/js/data-tracker.js"></script>
  <script src="shared/js/ui-components.js"></script>
  <script src="shared/js/personalization-service.js"></script>
  <script src="shared/js/personalization-counter.js"></script>
  <script src="shared/js/personalization-form.js"></script>
  <script src="shared/js/settings-modal.js"></script>
  <script src="shared/js/mobile-debug.js"></script>
  <script src="shared/utils/statistics.js"></script>

  <!-- Main menu JavaScript -->
  <script>
    class MainMenu {
      constructor() {
        this.init();
      }

      async init() {
        try {
          // Load settings using shared module
          window.SettingsModal.loadSettings();

          // Set up event listeners
          this.setupEventListeners();

          // Check if returning user
          const aggregateStats = window.DataTracker.getAggregateStats();
          const isReturningUser = aggregateStats && aggregateStats.totalSessions > 0;

          // Show appropriate screen
          if (isReturningUser) {
            this.renderDashboard();
            this.showDashboard();
          } else {
            this.showWelcome();
          }

          // Check if personalization preference popup should be shown
          window.SettingsModal.checkPersonalizationPopup();

          // Speak welcome (optional, may fail on page load due to browser restrictions)
          if (window.AudioManager && window.AudioManager.isEnabled()) {
            try {
              await window.AudioManager.speak('Welkom bij Cognitieve Training');
            } catch (speechError) {
              // Speech may fail on page load - this is expected browser behavior
              console.log('Speech unavailable on page load:', speechError);
            }
          }
        } catch (error) {
          console.error('Initialization error:', error);
          alert('Er is een fout opgetreden bij het laden van de applicatie.');
        }
      }

      setupEventListeners() {
        // Welcome screen - start button
        document.getElementById('start-button').addEventListener('click', () => {
          this.onStartClick();
        });

        // Dashboard - back button
        document.getElementById('dashboard-back-button').addEventListener('click', () => {
          this.showWelcome();
        });

        // Dashboard - continue button
        document.getElementById('continue-button').addEventListener('click', () => {
          this.navigateToDomains();
        });

        // Settings button - use shared modal
        document.getElementById('settings-button').addEventListener('click', () => {
          window.SettingsModal.show();
        });
      }

      onStartClick() {
        // Check if returning user
        const aggregateStats = window.DataTracker.getAggregateStats();
        const isReturningUser = aggregateStats && aggregateStats.totalSessions > 0;

        if (isReturningUser) {
          // Show dashboard for returning users
          this.renderDashboard();
          this.showDashboard();
        } else {
          // Go directly to domains for new users
          this.navigateToDomains();
        }
      }

      showWelcome() {
        document.getElementById('welcome-screen').style.display = 'flex';
        document.getElementById('dashboard-screen').style.display = 'none';
      }

      showDashboard() {
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('dashboard-screen').style.display = 'flex';
      }

      renderDashboard() {
        const aggregateStats = window.DataTracker.getAggregateStats();
        const dashboardEl = document.getElementById('dashboard-stats');

        if (!aggregateStats || aggregateStats.totalSessions === 0) {
          dashboardEl.innerHTML = '<p style="text-align: center;">Geen data beschikbaar</p>';
          return;
        }

        // Session goal: 10 sessions
        const sessionGoal = 10;
        const sessionsValue = `${aggregateStats.totalSessions}/${sessionGoal}`;

        // Time goal: 100 minutes (10 sessions √ó ~10 minutes each)
        const timeGoal = 100;
        const totalMinutes = Math.round(aggregateStats.totalTime / (1000 * 60));
        const timeValue = `${totalMinutes}/${timeGoal} minuten`;

        const stats = [
          { label: 'Totaal Sessies', value: sessionsValue },
          { label: 'Totale Tijd', value: timeValue },
          { label: 'Dagen Actief', value: aggregateStats.daysSinceStart },
        ];

        const statsPanel = UIComponents.createStatsPanel(stats);
        UIComponents.clearElement(dashboardEl);
        dashboardEl.appendChild(statsPanel);
      }

      navigateToDomains() {
        // Haptic feedback
        if (window.AudioManager) {
          window.AudioManager.hapticPress();
        }

        // Navigate to domains page
        window.location.href = 'domains.html';
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        new MainMenu();
      });
    } else {
      new MainMenu();
    }
  </script>

  <!-- PWA Installer -->
  <script src="shared/js/pwa-installer.js"></script>
</body>
</html>
